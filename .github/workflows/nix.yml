name: Nix

on:
  push:
    branches: 
      - master
  pull_request:
    branches: 
      - master
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Setup Nix
        uses: DeterminateSystems/nix-installer-action@main
        with:
          extra-conf: |
            extra-platforms = aarch64-linux      

      - name: Setup Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Log into registry ${{ env.REGISTRY }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        run: | # bash
          set -xeuo pipefail

          # Runner may run out of space in tmpfs
          unset TMPDIR
          
          # Build container
          nix build
          
          # Load container and extract image tag
          LOAD_OUTPUT=$(mktemp)
          docker load < result | tee $LOAD_OUTPUT
          read VERSION MAJOR_MINOR \
            <<<$(sed -E "s|Loaded image: $IMAGE_NAME:(([0-9]+\.[0-9]+)(\.[0-9])?)|\1 \2|" $LOAD_OUTPUT)

          # Tag image
          docker tag $IMAGE_NAME:$VERSION $IMAGE_NAME:$MAJOR_MINOR
          docker tag $IMAGE_NAME:$VERSION $IMAGE_NAME:latest
          
          # Push
          docker push -a $IMAGE_NAME
